jQuery.fn.springy=function(t){var e=this.graph=t.graph||new Springy.Graph,a=t.stiffness||400,i=t.repulsion||400,n=t.damping||.5,o=t.minEnergyThreshold||1e-5,r=t.nodeSelected||null,d={},l=this[0],s=l.getContext("2d"),g=this.layout=new Springy.Layout.ForceDirected(e,a,i,n,o),y=g.getBoundingBox(),h={bottomleft:new Springy.Vector(-2,-2),topright:new Springy.Vector(2,2)};Springy.requestAnimationFrame(function t(){h=g.getBoundingBox(),y={bottomleft:y.bottomleft.add(h.bottomleft.subtract(y.bottomleft).divide(10)),topright:y.topright.add(h.topright.subtract(y.topright).divide(10))},Springy.requestAnimationFrame(t)});var u=function(t){var e=y.topright.subtract(y.bottomleft),a=t.subtract(y.bottomleft).divide(e.x).x*l.width,i=t.subtract(y.bottomleft).divide(e.y).y*l.height;return new Springy.Vector(a,i)},f=function(t){var e=y.topright.subtract(y.bottomleft),a=t.x/l.width*e.x+y.bottomleft.x,i=t.y/l.height*e.y+y.bottomleft.y;return new Springy.Vector(a,i)},c=null,x=null,p=null;jQuery(l).mousedown(function(t){var e=jQuery(this).offset(),a=f({x:t.pageX-e.left,y:t.pageY-e.top});null!==(c=x=p=g.nearest(a)).node&&(p.point.m=1e4,r&&r(c.node)),v.start()}),jQuery(l).dblclick(function(t){var e=jQuery(this).offset(),a=f({x:t.pageX-e.left,y:t.pageY-e.top});c=g.nearest(a),node=c.node,node&&node.data&&node.data.ondoubleclick&&node.data.ondoubleclick()}),jQuery(l).mousemove(function(t){var e=jQuery(this).offset(),a=f({x:t.pageX-e.left,y:t.pageY-e.top});x=g.nearest(a),null!==p&&null!==p.node&&(p.point.p.x=a.x,p.point.p.y=a.y),v.start()}),jQuery(window).bind("mouseup",function(t){p=null}),Springy.Node.prototype.getHeight=function(){var t;return null==this.data.image?16:this.data.image.src in d&&d[this.data.image.src].loaded?void 0!==(t=this).data.image.height?t.data.image.height:d[t.data.image.src].object.height:10},Springy.Node.prototype.getWidth=function(){var t;return null==this.data.image?function(t){var e=void 0!==t.data.label?t.data.label:t.id;if(t._width&&t._width[e])return t._width[e];s.save(),s.font=void 0!==t.data.font?t.data.font:"16px Verdana, sans-serif";var a=s.measureText(e).width;return s.restore(),t._width||(t._width={}),t._width[e]=a,a}(this):this.data.image.src in d&&d[this.data.image.src].loaded?void 0!==(t=this).data.image.width?t.data.image.width:d[t.data.image.src].object.width:10};var v=this.renderer=new Springy.Renderer(g,function(){s.clearRect(0,0,l.width,l.height)},function(t,a,i){for(var n=u(a).x,o=u(a).y,r=u(i).x,d=u(i).y,l=new Springy.Vector(r-n,d-o),g=l.normal().normalise(),y=e.getEdges(t.source,t.target),h=e.getEdges(t.target,t.source),f=y.length+h.length,c=0,x=0;x<y.length;x++)y[x].id===t.id&&(c=x);var p=g.multiply(-12*(f-1)/2+12*c),v=u(a).add(p),b=u(i).add(p),w=t.target.getWidth()+6,S=t.target.getHeight()+6,F=function(t,e,a,i,n){var o,r={x:a.x,y:a.y},d={x:a.x+i,y:a.y},l={x:a.x,y:a.y+n},s={x:a.x+i,y:a.y+n};return(o=m(t,e,r,d))?o:(o=m(t,e,d,s))?o:(o=m(t,e,s,l))?o:!!(o=m(t,e,l,r))&&o}(v,b,{x:r-w/2,y:d-S/2},w,S);F||(F=b);var j,E=void 0!==t.data.color?t.data.color:"#000000",T=void 0!==t.data.weight?t.data.weight:1;s.lineWidth=Math.max(2*T,.1),j=1+s.lineWidth;var V,Q=void 0===t.data.directional||t.data.directional;if(V=Q?F.subtract(l.normalise().multiply(4)):b,s.strokeStyle=E,s.beginPath(),s.moveTo(v.x,v.y),s.lineTo(V.x,V.y),s.stroke(),Q&&(s.save(),s.fillStyle=E,s.translate(F.x,F.y),s.rotate(Math.atan2(d-o,r-n)),s.beginPath(),s.moveTo(-8,j),s.lineTo(0,0),s.lineTo(-8,-j),s.lineTo(-6.4,-0),s.closePath(),s.fill(),s.restore()),void 0!==t.data.label){text=t.data.label,s.save(),s.textAlign="center",s.textBaseline="top",s.font=void 0!==t.data.font?t.data.font:"8px Verdana, sans-serif",s.fillStyle=E;var B=Math.atan2(b.y-v.y,b.x-v.x),M=-8;(B>Math.PI/2||B<-Math.PI/2)&&(M=8,B+=Math.PI);var P=v.add(b).divide(2).add(g.multiply(M));s.translate(P.x,P.y),s.rotate(B),s.fillText(text,0,-2),s.restore()}},function(t,e){var a=u(e);s.save();var i=t.getWidth(),n=t.getHeight(),o=i+6,r=n+6;if(s.clearRect(a.x-o/2,a.y-r/2,o,r),null!==c&&null!==c.node&&c.node.id===t.id?s.fillStyle="#FFFFE0":null!==x&&null!==x.node&&x.node.id===t.id?s.fillStyle="#EEEEEE":s.fillStyle="#FFFFFF",s.fillRect(a.x-o/2,a.y-r/2,o,r),null==t.data.image){s.textAlign="left",s.textBaseline="top",s.font=void 0!==t.data.font?t.data.font:"16px Verdana, sans-serif",s.fillStyle=void 0!==t.data.color?t.data.color:"#000000";var l=void 0!==t.data.label?t.data.label:t.id;s.fillText(l,a.x-i/2,a.y-n/2)}else{var g=t.data.image.src;if(g in d)d[g].loaded&&s.drawImage(d[g].object,a.x-i/2,a.y-n/2,i,n);else{d[g]={};var y=new Image;d[g].object=y,y.addEventListener("load",function(){d[g].loaded=!0}),y.src=g}}s.restore()});function m(t,e,a,i){var n=(i.y-a.y)*(e.x-t.x)-(i.x-a.x)*(e.y-t.y);if(0===n)return!1;var o=((i.x-a.x)*(t.y-a.y)-(i.y-a.y)*(t.x-a.x))/n,r=((e.x-t.x)*(t.y-a.y)-(e.y-t.y)*(t.x-a.x))/n;return!(o<0||o>1||r<0||r>1)&&new Springy.Vector(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y))}return v.start(),this};